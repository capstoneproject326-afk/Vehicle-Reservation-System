<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vehicle Reservations</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
<style>
:root {
  --bg-main: #f1f5f9;
  --bg-sidebar: rgba(17, 24, 39, 0.8);
  --bg-topbar: rgba(255, 255, 255, 0.8);
  --text-color: #1f2937;
  --card-bg: rgba(255, 255, 255, 0.3);
}
body.dark {
  --bg-main: #1e293b;
  --bg-sidebar: rgba(30, 41, 59, 0.95);
  --bg-topbar: rgba(30, 41, 59, 0.95);
  --text-color: #f8fafc;
  --card-bg: rgba(51, 65, 85, 0.5);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; overflow: hidden; background-color: var(--bg-main); transition: background 0.3s ease; }

/* Sidebar */
.sidebar { width: 240px; background: var(--bg-sidebar); color: #fff; display: flex; flex-direction: column; backdrop-filter: blur(10px); }
.sidebar h2 { text-align: center; padding: 18px 10px; font-size: 18px; background: rgba(31, 41, 55, 0.9); }
.sidebar nav { display: flex; flex-direction: column; margin-top: 10px; }
.nav-link { padding: 12px 20px; font-size: 15px; color: #cbd5e0; text-decoration: none; display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent; }
.nav-link:hover { background-color: rgba(255,255,255,0.1); color: #fff; border-left: 4px solid #60a5fa; padding-left: 26px; }
.nav-link.active { background-color: #2563eb; color: #ffffff; border-left: 4px solid #3b82f6; }

/* Main */
.main { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--card-bg); overflow-y: auto; }
.topbar { background: var(--bg-topbar); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
.topbar h1 { font-size: 20px; color: var(--text-color); }
.dark-mode-toggle { background: #1f2937; color: #fff; border: none; padding: 10px; border-radius: 6px; margin-left: 10px; cursor: pointer; }
.logout-btn { background: #dc3545; color: #fff; border: none; padding: 10px 14px; font-size: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; }

/* Content Area */
.content { padding: 30px 40px; }
.filters label { margin-right: 10px; font-weight: bold; }
select, input[type="text"] { padding: 6px 12px; margin: 10px 10px 20px 0; border-radius: 4px; border: 1px solid #ccc; }
.reservation { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
.reservation h4 { margin: 0 0 10px; font-size: 20px; }
.badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; text-transform: capitalize; margin-left: 10px; }
.badge.pending { background: orange; color: white; }
.badge.approved { background: green; color: white; }
.badge.rejected { background: red; color: white; }
.actions { margin-top: 12px; }
.actions button { margin-right: 10px; }

/* Buttons */
.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  font-size: 14px;
  cursor: pointer;
  color: #fff;
  margin-right: 8px;
  transition: 0.2s;
}
.btn-success { background-color: #28a745; }
.btn-success:hover { background-color: #218838; }
.btn-danger { background-color: #dc3545; }
.btn-danger:hover { background-color: #c82333; }

.stats { margin-bottom: 20px; font-weight: bold; }
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h2>CTU Admin</h2>
  <nav>
    <a href="vehicle-reservations.html" class="nav-link active"><i class="fas fa-car"></i><span class="link-text">Vehicle Reservations</span></a>
    <a href="manage-vehicles.html" class="nav-link"><i class="fas fa-tools"></i><span class="link-text">Manage Vehicles</span></a>
    <a href="registered-drivers.html" class="nav-link"><i class="fas fa-id-badge"></i><span class="link-text">Registered Drivers</span></a>
    <a href="confirmed-reservations.html" class="nav-link"><i class="fas fa-check-circle"></i><span class="link-text">Confirmed Reservations</span></a>
    <a href="complete.html" class="nav-link"><i class="fas fa-file-alt"></i><span class="link-text">Complete</span></a>
    <a href="ontrip.html" class="nav-link"><i class="fas fa-route"></i><span class="link-text">On Trip</span></a>
    <a href="change-password.html" class="nav-link"><i class="fas fa-key"></i><span class="link-text">Change Password</span></a>
  </nav>
</div>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <h1>Vehicle Reservations</h1>
    <div>
      <button class="dark-mode-toggle" onclick="toggleDarkMode()">Dark Mode</button>
      <button id="logout" class="logout-btn">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="filters">
      <label for="statusFilter">Status:</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>

      <label for="searchName">Search Name:</label>
      <input type="text" id="searchName" placeholder="Enter name">

      <label for="dateFilter">Date:</label>
      <input type="text" id="dateFilter" placeholder="Select date">
    </div>

    <div class="stats" id="stats"></div>
    <div id="reservations"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1Guf5lPfPsgtpBTm4MY3r3N9a8wfQumY",
  authDomain: "vehicle-management-syste-8f7fe.firebaseapp.com",
  databaseURL: "https://vehicle-management-syste-8f7fe-default-rtdb.firebaseio.com",
  projectId: "vehicle-management-syste-8f7fe",
  storageBucket: "vehicle-management-syste-8f7fe.firebasestorage.app",
  messagingSenderId: "423136689247",
  appId: "1:423136689247:web:47dc93d0a171f06f096fea",
  measurementId: "G-PF0808T11H"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const reservationsRef = ref(db, 'reservations');

const statusFilter = document.getElementById('statusFilter');
const reservationsContainer = document.getElementById('reservations');
const searchName = document.getElementById('searchName');
const dateFilter = document.getElementById('dateFilter');
const statsDiv = document.getElementById('stats');

flatpickr("#dateFilter", { dateFormat: "Y-m-d" });

function renderStats(data) {
  const total = data.length;
  const pending = data.filter(r => r.status === 'pending').length;
  const approved = data.filter(r => r.status === 'approved').length;
  const rejected = data.filter(r => r.status === 'rejected').length;
  statsDiv.textContent = `Total: ${total}, Pending: ${pending}, Approved: ${approved}, Rejected: ${rejected}`;
}

function renderReservations() {
  onValue(reservationsRef, snapshot => {
    const rawData = snapshot.val();
    let reservations = [];
    for (const [id, r] of Object.entries(rawData || {})) {
      if (!r || typeof r !== 'object') continue;
      reservations.push({ id, ...r });
    }

    const status = statusFilter.value;
    const search = searchName.value.toLowerCase();
    const date = dateFilter.value;

    reservations = reservations.filter(r => 
      (status === 'all' || r.status === status) &&
      (!search || (r.name || '').toLowerCase().includes(search)) &&
      (!date || r.date === date)
    );

    reservations.sort((a, b) => {
      const priority = { pending: 0, approved: 1, rejected: 2 };
      return (priority[a.status] ?? 3) - (priority[b.status] ?? 3);
    });

    renderStats(reservations);
    reservationsContainer.innerHTML = '';

    reservations.forEach(r => {
      const div = document.createElement('div');
      div.className = 'reservation';
      div.innerHTML = `
        <h4>${r.name || 'Unknown'} <span class="badge ${r.status || 'pending'}">${r.status || 'pending'}</span></h4>
        <p><strong>Department:</strong> ${r.department || 'N/A'}</p>
        <p><strong>Category:</strong> ${Array.isArray(r.categories) ? r.categories.join(", ") : (r.categories || 'N/A')}</p>
        <p><strong>Purpose:</strong> ${r.purpose || 'N/A'}</p>
        <p><strong>Destination:</strong> ${r.destination || 'N/A'}</p>
        <p><strong>Date:</strong> ${r.date || 'N/A'}</p>
        <p><strong>Time Slot:</strong> ${r.timeSlot || 'N/A'}</p>
        <p><strong>Trip Type:</strong> ${r.tripType || 'N/A'}</p>
        <p><strong>No. of Passengers:</strong> ${r.passengers || 'N/A'}</p>
        <p><strong>Vehicle:</strong> ${r.vehicle || 'N/A'}</p>
        <p><strong>Plate:</strong> ${r.plate || 'N/A'}</p>
        <p><strong>Driver:</strong> ${r.driverName || '—'} (${r.driver || '—'})</p>
        <p><strong>Driver Email:</strong> ${r.driverEmail || '—'}</p>
        <div class="actions" id="actions-${r.id}"></div>
      `;

      reservationsContainer.appendChild(div);

      if (r.status === 'pending') {
        const actionsDiv = div.querySelector(`#actions-${r.id}`);

        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-success';
        approveBtn.textContent = 'Approve';
        approveBtn.onclick = () => {
          update(ref(db, `reservations/${r.id}`), { status: 'approved', notifyDriver: true })
            .then(() => { 
              alert("Reservation approved."); 
              renderReservations(); 
            });
        };

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-danger';
        rejectBtn.textContent = 'Reject';
        rejectBtn.onclick = () => {
          update(ref(db, `reservations/${r.id}`), { status: 'rejected', notifyDriver: false })
            .then(() => { 
              alert("Reservation rejected."); 
              renderReservations(); 
            });
        };

        actionsDiv.appendChild(approveBtn);
        actionsDiv.appendChild(rejectBtn);
      }
    });
  });
}

document.getElementById('logout').onclick = () => {
  signOut(auth).then(() => {
    alert("Logged out");
    window.location.href = "admin-login.html";
  });
};

onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Please log in first.");
    window.location.href = "admin-login.html";
  } else {
    renderReservations();
    statusFilter.onchange = searchName.oninput = dateFilter.onchange = renderReservations;
  }
});

function toggleDarkMode() {
  document.body.classList.toggle('dark');
}
</script>
</body>
</html>
