<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver Trip Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; margin: 0; background:#f9f9f9; }

  /* Header */
  header {
    background: #007BFF;
    color: #fff;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  header h2 { margin: 0; font-size: 20px; }
  header button {
    background: #dc3545;
    border: none;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }
  header button:hover { background:#b02a37; }

  #reservationsContainer { max-width:900px; margin:20px auto; padding:0 15px; }

  .reservation {
    padding:15px 20px;
    margin-bottom:20px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    background:#fff;
    transition: transform 0.2s;
  }
  .reservation:hover { transform: scale(1.02); }

  .reservation p { margin:6px 0; }
  .status-badge {
    padding:3px 8px;
    border-radius:12px;
    font-size:12px;
    font-weight: bold;
    color:#fff;
  }
  .approved .status-badge { background:#007BFF; }
  .ontrip .status-badge { background:#28a745; }
  .completed .status-badge { background:#6c757d; }

  .reservation button {
    margin:6px 6px 0 0;
    padding:8px 14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    transition: background 0.2s;
  }
  .confirm { background:#007BFF; color:#fff; }
  .confirm:hover { background:#0056b3; }
  .decline { background:#dc3545; color:#fff; }
  .decline:hover { background:#a71d2a; }
  .startTrip { background:#28a745; color:#fff; }
  .startTrip:hover { background:#1e7e34; }
  .endTrip { background:#ffc107; color:#000; }
  .endTrip:hover { background:#e0a800; }
  button:disabled { background:#ccc !important; cursor:not-allowed; }

  @media(max-width:600px) {
    .reservation { padding:12px; }
    .reservation button { width:100%; margin:8px 0; }
  }
</style>
</head>
<body>

<header>
  <h2>Driver Trip Dashboard</h2>
  <button id="logoutBtn">Logout</button>
</header>

<div id="reservationsContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA1Guf5lPfPsgtpBTm4MY3r3N9a8wfQumY",
  authDomain: "vehicle-management-syste-8f7fe.firebaseapp.com",
  databaseURL: "https://vehicle-management-syste-8f7fe-default-rtdb.firebaseio.com",
  projectId: "vehicle-management-syste-8f7fe",
  storageBucket: "vehicle-management-syste-8f7fe.firebasestorage.app",
  messagingSenderId: "423136689247",
  appId: "1:423136689247:web:47dc93d0a171f06f096fea",
  measurementId: "G-PF0808T11H"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const reservationsContainer = document.getElementById("reservationsContainer");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn.onclick = () => {
  signOut(auth).then(() => {
    window.location.href = "driver-login.html";
  }).catch(err => alert("Logout failed: " + err.message));
};

function getTimestamp() {
  return new Date().toISOString();
}

onAuthStateChanged(auth, user => {
  if(!user) window.location.href = "driver-login.html";
  const driverEmail = user.email.trim().toLowerCase();

  onValue(ref(db,"reservations"), snapshot => {
    reservationsContainer.innerHTML = "";
    if(snapshot.exists()){
      let reservations = [];
      snapshot.forEach(child => {
        const data = child.val();
        const key = child.key;
        const status = data.status?.toLowerCase();
        const driverMatch = data.driverEmail?.trim().toLowerCase() === driverEmail;
        if(["approved","ontrip","completed"].includes(status) && driverMatch){
          reservations.push({ key, data });
        }
      });

      // Sort newest first
      reservations.sort((a,b) => b.data.timestamp - a.data.timestamp);

      reservations.forEach(r => {
        const data = r.data;
        const key = r.key;
        const div = document.createElement("div");
        div.className = "reservation " + (data.status?.toLowerCase() || "approved");
        div.id = `reservation-${key}`;

        div.innerHTML = `
          <p><strong>Name:</strong> ${data.name || "N/A"}</p>
          <p><strong>Destination:</strong> ${data.destination || "N/A"}</p>
          <p><strong>Vehicle:</strong> ${data.vehicle || "N/A"}</p>
          <p><strong>Plate Number:</strong> ${data.plate || "N/A"}</p>
          <p><strong>Date:</strong> ${data.date || "N/A"}</p>
          <p><strong>Time Slot:</strong> ${data.timeSlot || "N/A"}</p>
          <p><strong>Status:</strong> <span class="status-badge">${data.status}</span></p>
          <p><strong>Driver Confirmation:</strong> ${data.driverConfirmation || "Not yet"}</p>
        `;

        // Buttons
        const confirmBtn = document.createElement("button");
        confirmBtn.className = "confirm";
        confirmBtn.textContent = "Confirm";

        const declineBtn = document.createElement("button");
        declineBtn.className = "decline";
        declineBtn.textContent = "Decline";

        const startBtn = document.createElement("button");
        startBtn.className = "startTrip";
        startBtn.textContent = "Start Trip";

        const endBtn = document.createElement("button");
        endBtn.className = "endTrip";
        endBtn.textContent = "End Trip";

        // Disable logic
        if(data.driverConfirmation === "Confirmed" || data.status === "ontrip" || data.status === "completed") {
          confirmBtn.disabled = true;
          declineBtn.disabled = true;
        }
        startBtn.disabled = !(data.driverConfirmation === "Confirmed" && data.status.toLowerCase() === "approved");
        endBtn.disabled = data.status.toLowerCase() !== "ontrip";

        // Actions
        confirmBtn.onclick = async () => {
          await update(ref(db, `reservations/${key}`), { driverConfirmation: "Confirmed" });
          confirmBtn.disabled = true;
          declineBtn.disabled = true;
          startBtn.disabled = false;
          div.querySelector(".status-badge").textContent = "Approved";
          div.className = "reservation approved";
          alert("Trip confirmed.");
        };

        declineBtn.onclick = async () => {
          await update(ref(db, `reservations/${key}`), { driverConfirmation: "Declined" });
          confirmBtn.disabled = true;
          declineBtn.disabled = true;
          startBtn.disabled = true;
          div.querySelector(".status-badge").textContent = "Declined";
          alert("Trip declined.");
        };

        startBtn.onclick = async () => {
          await update(ref(db, `reservations/${key}`), { tripStartTime: getTimestamp(), status: "ONTRIP" });
          div.querySelector(".status-badge").textContent = "ONTRIP";
          div.className = "reservation ontrip";
          startBtn.disabled = true;
          endBtn.disabled = false;
        };

        endBtn.onclick = async () => {
          await update(ref(db, `reservations/${key}`), { status: "Completed", tripEndTime: getTimestamp() });
          div.querySelector(".status-badge").textContent = "Completed";
          div.className = "reservation completed";
          [confirmBtn, declineBtn, startBtn, endBtn].forEach(b => b.disabled = true);
          alert("Trip ended and reservation completed!");
        };

        div.appendChild(confirmBtn);
        div.appendChild(declineBtn);
        div.appendChild(startBtn);
        div.appendChild(endBtn);

        reservationsContainer.appendChild(div);
      });
    } else {
      reservationsContainer.innerHTML = "<p>No reservations found.</p>";
    }
  });
});
</script>
</body>
</html>
