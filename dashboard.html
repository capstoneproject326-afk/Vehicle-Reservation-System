<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CTU Vehicle Reservation</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  
   <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />



  
  <style>
    * {
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(to right, #2b85f3, #4bc7d8);
      padding: 20px;
      color: #1f2937;
    }

    h2 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 28px;
      font-weight: 600;
      color: #f0eff1; /* deep purple */
    }

    form {
      max-width: 700px;
      margin: auto;
      background: #ffffff;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: #374151;
    }

    input, select, textarea, button {
      width: 100%;
      margin-top: 6px;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 15px;
      transition: border 0.3s, box-shadow 0.3s, transform 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #06b6d4; /* teal focus */
      box-shadow: 0 0 8px rgba(6,182,212,0.25);
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 90px;
    }

    button {
      margin-top: 18px;
      background: #178149; /* purple main */
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      font-weight: 600;
      padding: 12px;
      transition: background 0.3s, transform 0.2s;
    }

    button:hover {
      background: #2e6e4c; /* lighter purple */
      transform: translateY(-2px);
    }

    #logoutBtn, #myReservationsBtn {
      width: 220px;
      margin: 12px auto;
      display: block;
      font-size: 15px;
      font-weight: 600;
    }

    #logoutBtn {
      background: #4063b6; /* danger pink-red */
    }

    #logoutBtn:hover {
      background: #4f7de7;
    }

    #myReservationsBtn {
      background: #2E4F9E; /* teal green */
    }

    #myReservationsBtn:hover {
      background: #497bf1;
    }

    .department-category {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    /* Vehicle Preview */
    .vehicle-preview {
      text-align: center;
      margin-top: 10px;
      display: none;
    }

    .vehicle-preview img {
      width: 100%;
      max-height: 350px;
      border-radius: 14px;
      margin-bottom: 14px;
      object-fit: cover;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .vehicle-info {
      font-size: 15px;
      font-weight: 500;
      color: #4b5563;
      margin-bottom: 12px;
    }

    /* Popup Overlay */
    #popupOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    /* Booking Popup */
    #bookingPopup {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      padding: 25px;
      width: 95%;
      max-width: 600px;
      max-height: 80%;
      overflow-y: auto;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: popupFade 0.3s ease-out;
    }

    @keyframes popupFade {
      from {opacity: 0; transform: translate(-50%, -45%);}
      to {opacity: 1; transform: translate(-50%, -50%);}
    }

    #bookingPopup h3 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 600;
      color: #333333
    ;
    }

    #bookingPopup table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
    }

    #bookingPopup th, #bookingPopup td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 14px;
    }

    #bookingPopup th {
      background: #f3f4f6;
      font-weight: 600;
    }

    #bookingPopup tr:nth-child(even) {
      background: #fafafa;
    }

    #showBookingsBtn {
      margin-top: 10px;
      max-width: 340px;
      background: #06b6d4;
    }

    #showBookingsBtn:hover {
      background: #0ea5e9;
    }

    #closePopup {
      background: #f43f5e;
      font-weight: bold;
      margin-top: 15px;
    }

    #closePopup:hover {
      background: #e11d48;
    }

    /* Flatpickr Calendar Dots & Disabled Dates */
    .flatpickr-day .note-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      background-color: #2E6E4C; /* purple */
      border-radius: 50%;
      margin-left: 2px;
    }

    .flatpickr-day.flatpickr-disabled {
      background: #f3f4f6 !important;
      color: #9ca3af !important;
      cursor: not-allowed;
    }

    /* Input & Table hover effects */
    #bookingPopup tbody tr:hover {
      background-color: #e0f7fa; /* teal highlight */
    }

    input::placeholder, textarea::placeholder {
      color: #9ca3af;
      opacity: 1;
    }

    /* Responsive adjustments */
    @media(max-width:768px){
      .department-category {
        flex-direction: column;
      }
      #logoutBtn, #myReservationsBtn {
        width: 100%;
      }
      .vehicle-preview img {
        max-height: 250px;
      }
    }

    /* Popups */
    #popupOverlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:999; }
    #mapPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; background:#fff; padding:12px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.3); width:92%; max-width:720px; height:520px; }

    #map { height:420px; border-radius:8px; width:100%; }
    @media(max-width:720px){ form { padding:18px; } #mapPopup { height:420px; } }





  </style>
</head>
<body>




<!-- Chatbot Toggle Button -->
<button id="chatbotToggle">üí¨</button>

<!-- Chatbot Container -->
<div id="chatbot">
  <div id="chatbotHeader">
    Chatbot
    <button id="chatbotClose">Close Chatbot</button>
  </div>
  <div id="chatbotMessages"></div>
  <div id="faqContainer">
    <select id="faqDropdown">
      <option value="">-- Select FAQ --</option>
    </select>
  </div>
  <div id="chatInputContainer">
    <input type="text" id="chatInput" placeholder="Type your question...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<style>
/* Chatbot Styles */
#chatbotToggle {
  position: fixed;
  bottom: 20px; right: 20px;
  width: 55px; height: 55px;
  border-radius: 50%;
  background: #3f6dda;
  color: #fff;
  font-size: 28px;
  border: none;
  cursor: pointer;
  z-index: 1002;
  box-shadow: 0 4px 15px rgba(0,0,0,0.25);
  transition: transform 0.2s;
}
#chatbotToggle:hover { transform: scale(1.1); }

#chatbot {
  display: none;
  position: fixed; bottom: 90px; right: 20px;
  width: 340px; max-height: 500px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  flex-direction: column;
  font-family: 'Poppins', sans-serif;
  z-index: 1001;
  overflow: hidden;
}

#chatbotHeader {
  padding: 12px 16px;
  background: #2E4F9E;
  color: #fff;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 16px;
}

#chatbotMessages {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  background: #f9fafb;
}

#faqContainer {
  padding: 8px 12px;
  background: #f3f4f6;
  border-top: 1px solid #e5e7eb;
}

#faqDropdown {
  width: 100%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #cbd5e1;
  font-size: 14px;
}

#chatInputContainer {
  display: flex;
  border-top: 1px solid #e5e7eb;
  background: #fff;
}

#chatInput {
  flex: 1;
  padding: 10px 14px;
  border: none;
  outline: none;
  font-size: 14px;
}

#sendBtn {
  background: #2E6E4C;
  color: #fff;
  border: none;
  padding: 0 16px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 0 8px 8px 0;
  transition: background 0.2s, transform 0.1s;
}
#sendBtn:hover {
  background: #137a43;
  transform: translateY(-1px);
}

/* Chat message bubbles */
.chat-bubble {
  max-width: 75%;
  padding: 10px 14px;
  border-radius: 16px;
  font-size: 15px;
  line-height: 1.4;
  word-wrap: break-word;
}

.chat-bubble.user {
  align-self: flex-end;
  background: #2E6E4C
  color: #fff;
  border-bottom-right-radius: 4px;
}

.chat-bubble.bot {
  align-self: flex-start;
  background: #e0f7fa;
  color: #1f2937;
  border-bottom-left-radius: 4px;
}

/* Scrollbar styling */
#chatbotMessages::-webkit-scrollbar {
  width: 6px;
}
#chatbotMessages::-webkit-scrollbar-thumb {
  background: rgba(251, 248, 253, 0.5);
  border-radius: 3px;
}
#chatbotMessages::-webkit-scrollbar-track {
  background: #f3f4f6;
}

/* Responsive adjustments */
@media(max-width:480px){
  #chatbot { width: 90%; right: 5%; bottom: 70px; max-height: 400px; }
  #chatbotToggle { width: 45px; height: 45px; font-size: 22px; }
}

</style>



  <h2>User Dashboard</h2>
  <button id="logoutBtn">Logout</button>
  <button id="myReservationsBtn">My Reservations</button>

  <form id="reservationForm">
    <label for="name">Name:</label>
    <input type="text" id="name" required>

    <div class="department-category">
      <div style="flex:1;">
        <label for="department">Department:</label>
        <select id="department" required>
          <option value="">Select Department</option>
          <option value="Supreme Student Government">Supreme Student Government</option>
          <option value="TechnoGadget Organization">TechnoGadget Organization</option>
          <option value="Educator's League">Educator's League</option>
          <option value="Host Guild">Host Guild</option>
          <option value="Engineering Society">Engineering Society</option>
        </select>
      </div>

      <div style="flex:1;">
        <label for="category">Category:</label>
        <select id="category" required>
          <option value="">Select Category</option>
          <option value="Faculty">Faculty</option>
          <option value="Organization">Organization</option>
          <option value="Staff">Staff</option>
        </select>
      </div>
    </div>

    <label for="purpose">Purpose:</label>
    <textarea id="purpose" required></textarea>

    <label for="destination">Destination:</label>
    <input type="text" id="destination" required>


        <label for="landmark">Landmark</label>
    <div style="display:flex; gap:10px; align-items:center;">
      <input type="text" id="landmark" placeholder="Click map icon to pin..." required />
      <button type="button" id="openMapBtn" style="width:auto;padding:10px 14px;">üìç Pin on Map</button>
    </div>

    <label for="tripType">Trip Type:</label>
    <select id="tripType" required>
      <option value="">Select Trip Type</option>
      <option value="One Way">One Way</option>
      <option value="Roundtrip">Roundtrip</option>
    </select>

    <label for="contact">Contact Info:</label>
    <input type="text" id="contact" required>

    <label for="vehicle">Vehicle:</label>
    <select id="vehicle" required>
      <option value="">Loading...</option>
    </select>

    <div class="vehicle-preview" id="vehiclePreview">
      <img id="vehicleImage" src="" alt="Vehicle">
      <div class="vehicle-info" id="vehicleSeats"></div>
      <button type="button" id="showBookingsBtn">Show Booking on this Vehicle</button>
    </div>

    <label for="driver">Driver:</label>
    <select id="driver" required>
      <option value="">Loading...</option>
    </select>

    <label for="date">Preferred Date:</label>
    <input type="text" id="date" required>

    <label for="timeSlot">Time Slot:</label>
    <select id="timeSlot" required>
      <option value="">Select</option>
      <option value="8:00 AM - 10:00 AM">8:00 AM - 10:00 AM</option>
      <option value="10:00 AM - 12:00 PM">10:00 AM - 12:00 PM</option>
      <option value="1:00 PM - 3:00 PM">1:00 PM - 3:00 PM</option>
      <option value="3:00 PM - 5:00 PM">3:00 PM - 5:00 PM</option>
    </select>

    <label for="passengers">No. of Passengers:</label>
    <input type="number" id="passengers" min="1" required>

    <button type="submit">Submit Reservation</button>
  </form>


    <!-- Map Modal -->
  <div id="mapPopup">
    <h3 style="text-align:center;margin:6px 0 8px 0;">Select Destination (click the map)</h3>
    <div id="map"></div>
    <div style="margin-top:10px; text-align:right;">
      <button id="confirmMapBtn" style="background:#178149;color:#fff;padding:8px 14px;border:none;border-radius:8px;margin-right:8px;">Confirm</button>
      <button id="closeMapBtn" style="background:#f43f5e;color:#fff;padding:8px 14px;border:none;border-radius:8px;">Close</button>
    </div>
  </div>

  <!-- Leaflet + Flatpickr -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>




  <!-- Popup Overlay -->
  <div id="popupOverlay"></div>

  <!-- Booking Popup -->
  <div id="bookingPopup">
    <h3>Bookings for this Vehicle</h3>

    <!-- Filters -->
    <div style="margin-bottom:15px;">
      <label for="filterDate">Filter by Date:</label>
      <input type="date" id="filterDate" style="width:100%; padding:8px; margin-bottom:8px; border-radius:6px;">

      <label for="filterDestination">Filter by Destination:</label>
      <input type="text" id="filterDestination" placeholder="Enter destination" style="width:100%; padding:8px; border-radius:6px;">
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Slot</th>
          <th>Destination</th>
          <th>Driver</th>
          <th>Passengers</th>
        </tr>
      </thead>
      <tbody id="bookingTableBody"></tbody>
    </table>
    <button id="closePopup" style="margin-top:12px;">Close</button>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, push, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1Guf5lPfPsgtpBTm4MY3r3N9a8wfQumY",
      authDomain: "vehicle-management-syste-8f7fe.firebaseapp.com",
      databaseURL: "https://vehicle-management-syste-8f7fe-default-rtdb.firebaseio.com",
      projectId: "vehicle-management-syste-8f7fe",
      storageBucket: "vehicle-management-syste-8f7fe.firebasestorage.app",
      messagingSenderId: "423136689247",
      appId: "1:423136689247:web:47dc93d0a171f06f096fea",
      measurementId: "G-PF0808T11H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const logoutBtn = document.getElementById("logoutBtn");
    const myReservationsBtn = document.getElementById("myReservationsBtn");
    const vehicleSelect = document.getElementById("vehicle");
    const driverSelect = document.getElementById("driver");
    const vehiclePreview = document.getElementById("vehiclePreview");
    const vehicleImage = document.getElementById("vehicleImage");
    const vehicleSeats = document.getElementById("vehicleSeats");
    const timeSlotSelect = document.getElementById("timeSlot");
    const dateInput = document.getElementById("date");
    const showBookingsBtn = document.getElementById("showBookingsBtn");
    const bookingTableBody = document.getElementById("bookingTableBody");
    const popupOverlay = document.getElementById("popupOverlay");
    const bookingPopup = document.getElementById("bookingPopup");
    const closePopup = document.getElementById("closePopup");

    function formatLocalDate(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2,'0');
      const dd = String(date.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = "reserve.html";
    });

    logoutBtn.onclick = () => signOut(auth).then(() => window.location.href="reserve.html");
    myReservationsBtn.onclick = () => window.location.href="my-reservations.html";

    // Load vehicles
    get(ref(db,"vehicles")).then(snapshot=>{
      vehicleSelect.innerHTML='<option value="">Select Vehicle</option>';
      if(snapshot.exists()){
        Object.values(snapshot.val()).forEach(vehicle=>{
          const opt=document.createElement("option");
          opt.value=JSON.stringify({name:vehicle.name,plate:vehicle.plate,image:vehicle.photo,seats:vehicle.seats});
          opt.textContent=`${vehicle.name} (${vehicle.plate})`;
          vehicleSelect.appendChild(opt);
        });
      }
    });

    vehicleSelect.addEventListener("change",()=>{
      if(!vehicleSelect.value){
        vehiclePreview.style.display="none";
        updateTimeSlots();
        return;
      }
      const v=JSON.parse(vehicleSelect.value);
      vehicleImage.src=v.image?v.image.startsWith("data:image")?v.image:"data:image/jpeg;base64,"+v.image:"";
      vehicleSeats.textContent=v.seats?`Number of seats: ${v.seats}`:"";
      vehiclePreview.style.display="block";
      updateTimeSlots();
    });

    // Load drivers
    get(ref(db,"drivers")).then(snapshot=>{
      driverSelect.innerHTML='<option value="">Select Driver</option>';
      if(snapshot.exists()){
        Object.values(snapshot.val()).forEach(driver=>{
          const opt=document.createElement("option");
          opt.value=JSON.stringify({name:driver.name,email:driver.email});
          opt.textContent=driver.name;
          driverSelect.appendChild(opt);
        });
      }
    });

    driverSelect.addEventListener("change",updateTimeSlots);
    dateInput.addEventListener("change",updateTimeSlots);

    let bookedDates={};
const fp = flatpickr("#date", {
  dateFormat: "Y-m-d",
  onDayCreate: function(dObj, dStr, fpObj, dayElem) {
    const dateStr = formatLocalDate(dayElem.dateObj);

    if(bookedDates[dateStr]){
      // Show notes for each reservation
      const notes = bookedDates[dateStr].map(r => `üöê ${r.vehicle} - ${r.driver} (${r.timeSlot})`);
      if(notes.length > 0){
        const dot = document.createElement("span");
        dot.classList.add("note-dot");
        dot.textContent = "‚Ä¢";
        dot.title = notes.join("\n");
        dayElem.appendChild(dot);
      }

      // Disable date if all vehicles are fully booked for all timeslots
      get(ref(db,"vehicles")).then(snapshot => {
        if(snapshot.exists()){
          const allVehicles = Object.values(snapshot.val());
          const timeSlots = Array.from(timeSlotSelect.options).slice(1).map(opt=>opt.value);
          let allFull = true;

          for(const v of allVehicles){
            const vehicleReservations = bookedDates[dateStr].filter(r => r.vehicle === v.name);
            for(const ts of timeSlots){
              const totalSeatsBooked = vehicleReservations.filter(r => r.timeSlot === ts).reduce((sum,x)=>sum+(x.seats||0),0);
              if(totalSeatsBooked < v.seats){
                allFull = false; // at least one vehicle has a free seat
                break;
              }
            }
            if(!allFull) break;
          }

          if(allFull) dayElem.classList.add("flatpickr-disabled");
        }
      });
    }
  }
});

// Listen for reservations in real-time and update bookedDates
onValue(ref(db,"reservations"), snapshot => {
  bookedDates = {};
  if(snapshot.exists()){
    Object.values(snapshot.val()).forEach(r => {
      if(!bookedDates[r.date]) bookedDates[r.date] = [];
      bookedDates[r.date].push({
        vehicle: r.vehicle,
        driver: r.driver,
        timeSlot: r.timeSlot,
        seats: r.passengers,
        destination: r.destination
      });
    });
  }

  fp.redraw();       // Refresh calendar for disabled dates
  updateTimeSlots(); // Refresh timeslot availability
});

// Update timeslots based on selected vehicle and date only
function updateTimeSlots(){
  const selectedDate = dateInput.value;
  const vehicleData = vehicleSelect.value ? JSON.parse(vehicleSelect.value) : null;

  Array.from(timeSlotSelect.options).forEach(opt => {
    if(opt.value === "") return;
    opt.disabled = false;

    if(!selectedDate || !vehicleData || !bookedDates[selectedDate]){
      opt.textContent = opt.value;
      return;
    }

    // Seats left for this vehicle at this time
    const totalSeatsBooked = bookedDates[selectedDate]
      .filter(r => r.vehicle === vehicleData.name && r.timeSlot === opt.value)
      .reduce((sum,x) => sum + (x.seats||0),0);
    const seatsLeft = vehicleData.seats - totalSeatsBooked;
    opt.textContent = `${opt.value} (${seatsLeft} seats left)`;
    if(seatsLeft <= 0) opt.disabled = true;
  });
}

// Trigger timeslot update when date or vehicle changes
vehicleSelect.addEventListener("change", updateTimeSlots);
dateInput.addEventListener("change", updateTimeSlots);


    document.getElementById("reservationForm").addEventListener("submit",async function(e){
      e.preventDefault();
      const user=auth.currentUser;
      if(!user) return;

      if(!vehicleSelect.value||!driverSelect.value){ alert("Select vehicle and driver"); return;}

      const selectedVehicle=JSON.parse(vehicleSelect.value);
      const selectedDriver=JSON.parse(driverSelect.value);
      const categories=Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb=>cb.value);
      const passengers=parseInt(document.getElementById("passengers").value);
      const selectedDate=dateInput.value;
      const selectedTimeSlot=timeSlotSelect.value;

      if(passengers>selectedVehicle.seats){ alert("‚ùå Passengers exceed vehicle seat capacity!"); return;}

      const snapshot=await get(ref(db,"reservations"));
      let totalSeatsForVehicle=0;
      let driverAlreadyBooked=false;

      if(snapshot.exists()){
        Object.values(snapshot.val()).forEach(r=>{
          if(r.date===selectedDate&&r.vehicle===selectedVehicle.name&&r.timeSlot===selectedTimeSlot) totalSeatsForVehicle+=r.passengers||0;
          if(r.date===selectedDate&&r.driver===selectedDriver.name&&r.timeSlot===selectedTimeSlot&&r.vehicle!==selectedVehicle.name) driverAlreadyBooked=true;
        });
      }

      if(totalSeatsForVehicle+passengers>selectedVehicle.seats){
        alert(`‚ùå Cannot book! Vehicle is full for this date and time slot. (${totalSeatsForVehicle}/${selectedVehicle.seats} seats already booked)`);
        return;
      }

      if(driverAlreadyBooked){
        alert(`‚ùå Cannot book! Driver ${selectedDriver.name} is already assigned to another vehicle at this time.`);
        return;
      }

const reservation = {
  name: document.getElementById("name").value,
  department: document.getElementById("department").value,
  categories: Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => cb.value),
  purpose: document.getElementById("purpose").value,
  destination: document.getElementById("destination").value,
  landmark: document.getElementById("landmark").value,
  tripType: document.getElementById("tripType").value,
  contact: document.getElementById("contact").value,
  date: selectedDate,
  timeSlot: selectedTimeSlot,
  passengers: passengers,
  vehicle: selectedVehicle.name,
  plate: selectedVehicle.plate,
  seats: selectedVehicle.seats,
  driver: selectedDriver.name,
  driverEmail: selectedDriver.email,
  status: "pending",
  userEmail: user.email
};

      const newReservationRef=push(ref(db,"reservations"));
      await set(newReservationRef,reservation);
      alert("‚úÖ Reservation submitted!");
      this.reset();
      vehiclePreview.style.display="none";
      updateTimeSlots();
    });

showBookingsBtn.addEventListener("click", async ()=> {
  if(!vehicleSelect.value) return;
  const vehicleData = JSON.parse(vehicleSelect.value);
  bookingTableBody.innerHTML = "";

  const filterDate = document.getElementById("filterDate").value;
  const filterDestination = document.getElementById("filterDestination").value.toLowerCase();

  const snapshot = await get(ref(db,"reservations"));
  if(snapshot.exists()){
    let reservations = Object.values(snapshot.val())
      .filter(r => r.vehicle === vehicleData.name && (r.status === "approved" || r.status === "pending"));

    // Apply filters
    if(filterDate) reservations = reservations.filter(r => r.date === filterDate);
    if(filterDestination) reservations = reservations.filter(r => r.destination.toLowerCase().includes(filterDestination));

    if(reservations.length === 0){
      bookingTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px;">No bookings for this vehicle</td></tr>`;
    } else {
      reservations.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.timeSlot}</td><td>${r.destination}</td><td>${r.driver}</td><td>${r.passengers}</td>`;
        bookingTableBody.appendChild(tr);
      });
    }
  } else {
    bookingTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px;">No bookings found</td></tr>`;
  }

  popupOverlay.style.display = "block";
  bookingPopup.style.display = "block";
});


    closePopup.addEventListener("click", ()=>{
      bookingPopup.style.display="none";
      popupOverlay.style.display="none";
    });

    popupOverlay.addEventListener("click", ()=>{
      bookingPopup.style.display="none";
      popupOverlay.style.display="none";
    });



async function loadVehicleBookings() {
  if(!vehicleSelect.value) return;
  const vehicleData = JSON.parse(vehicleSelect.value);
  bookingTableBody.innerHTML = "";

  const filterDate = document.getElementById("filterDate").value;
  const filterDestination = document.getElementById("filterDestination").value.toLowerCase();

  const snapshot = await get(ref(db,"reservations"));
  if(snapshot.exists()){
    let reservations = Object.values(snapshot.val())
      .filter(r => r.vehicle === vehicleData.name && (r.status === "approved" || r.status === "pending"));

    // Apply filters
    if(filterDate) reservations = reservations.filter(r => r.date === filterDate);
    if(filterDestination) reservations = reservations.filter(r => r.destination.toLowerCase().includes(filterDestination));

    if(reservations.length === 0){
      bookingTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px;">No bookings for this vehicle</td></tr>`;
    } else {
      reservations.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.date}</td><td>${r.timeSlot}</td><td>${r.destination}</td><td>${r.driver}</td><td>${r.passengers}</td>`;
        bookingTableBody.appendChild(tr);
      });
    }
  } else {
    bookingTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:10px;">No bookings found</td></tr>`;
  }

  popupOverlay.style.display = "block";
  bookingPopup.style.display = "block";
}


// Show bookings when button clicked
showBookingsBtn.addEventListener("click", loadVehicleBookings);

// Real-time filtering
document.getElementById("filterDate").addEventListener("change", loadVehicleBookings);
document.getElementById("filterDestination").addEventListener("input", loadVehicleBookings);



document.addEventListener("DOMContentLoaded", () => {
  const chatMessages = document.getElementById("chatbotMessages");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatbot = document.getElementById("chatbot");
  const chatbotToggle = document.getElementById("chatbotToggle");
  const chatbotClose = document.getElementById("chatbotClose");
  const faqDropdown = document.getElementById("faqDropdown");

  // FAQ responses
  const faqResponses = {
    "How do I cancel my reservation?": "You may cancel your reservation by contacting the admin office or replying to your confirmation message.",
    "Can I reserve on weekends?": "Vehicle usage on weekends is subject to approval and availability. Request in advance.",
    "How far in advance should I reserve?": "We recommend reserving at least 2‚Äì3 days in advance for vehicle availability.",
    "What types of vehicles are available?": "Available vehicle types include Coaster Van. For special requests, contact the transport office.",
    "What are the available reservation hours?": "Vehicles can be reserved Monday to Friday, from 8:00 AM to 5:00 PM. Outside hours require special approval.",
    "Who can make a reservation?": "CTU Danao faculty, staff, and authorized personnel can reserve vehicles. Provide full name and purpose.",
    "Where can I go with the vehicle?": "Trips should be within authorized areas. Outside Cebu province requires special clearance.",
    "Can I make multiple reservations?": "Yes, but each request must be submitted separately and is subject to approval and availability."
  };

  // Populate FAQ dropdown
  Object.keys(faqResponses).forEach(q => {
    const opt = document.createElement("option");
    opt.value = q; opt.textContent = q;
    faqDropdown.appendChild(opt);
  });

  // Toggle chatbot visibility
  chatbotToggle.addEventListener("click", () => {
    chatbot.style.display = chatbot.style.display === "flex" ? "none" : "flex";
    chatbot.style.flexDirection = "column";
  });

  // Close chatbot
  chatbotClose.addEventListener("click", () => chatbot.style.display = "none");

  // Send message function
  function sendMessage(msg) {
    const message = msg.trim();
    if (!message) return;
    chatInput.value = "";
    addMessage("You", message);

    const responseKey = Object.keys(faqResponses).find(key => key.toLowerCase().includes(message.toLowerCase()));
    const response = responseKey ? faqResponses[responseKey] : "Sorry, I don't understand that. Please ask about reservations or vehicles.";
    
    setTimeout(() => addMessage("Bot", response), 400);
  }

  // Add message to chat
  function addMessage(sender, text) {
    const msgDiv = document.createElement("div");
    msgDiv.style.maxWidth = "80%"; msgDiv.style.padding = "10px 14px";
    msgDiv.style.borderRadius = "14px"; msgDiv.style.wordWrap = "break-word";
    msgDiv.style.fontSize = "16px"; msgDiv.style.lineHeight = "1.4";
    if (sender === "You") {
      msgDiv.style.alignSelf = "flex-end"; msgDiv.style.background = "#6b21a8"; msgDiv.style.color = "#fff";
    } else {
      msgDiv.style.alignSelf = "flex-start"; msgDiv.style.background = "#e0f7fa"; msgDiv.style.color = "#1f2937";
    }
    msgDiv.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Send message by button or Enter key
  sendBtn.addEventListener("click", () => sendMessage(chatInput.value));
  chatInput.addEventListener("keypress", e => {
    if (e.key === "Enter") { e.preventDefault(); sendMessage(chatInput.value); }
  });

  // Send message by FAQ selection
  faqDropdown.addEventListener("change", () => {
    const selected = faqDropdown.value;
    if (selected) { sendMessage(selected); faqDropdown.value = ""; }
  });
});


 flatpickr("#date", { dateFormat: "Y-m-d" });

    const openMapBtn = document.getElementById('openMapBtn');
    const mapPopup = document.getElementById('mapPopup');
    const closeMapBtn = document.getElementById('closeMapBtn');
    const confirmMapBtn = document.getElementById('confirmMapBtn');
    const landmarkInput = document.getElementById('landmark');

   // === MAP PICKER LOGIC ===
let map, marker, selectedCoords = null;

const mapPopup = document.getElementById("mapPopup");
const openMapBtn = document.getElementById("openMapBtn");
const closeMapBtn = document.getElementById("closeMapBtn");
const confirmMapBtn = document.getElementById("confirmMapBtn");
const landmarkInput = document.getElementById("landmark");

// Open map popup
openMapBtn.addEventListener("click", () => {
  mapPopup.style.display = "block";
  if (!map) {
    map = L.map("map").setView([10.3157, 123.8854], 13); // Cebu center default
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Add marker on click
    map.on("click", function (e) {
      selectedCoords = e.latlng;
      if (marker) map.removeLayer(marker);
      marker = L.marker(selectedCoords).addTo(map);
    });
  }
  setTimeout(() => map.invalidateSize(), 200);
});

// Close popup without saving
closeMapBtn.addEventListener("click", () => {
  mapPopup.style.display = "none";
});

// Confirm and store coordinates
confirmMapBtn.addEventListener("click", () => {
  if (!selectedCoords) {
    alert("Please click on the map to select a landmark.");
    return;
  }
  // Store coordinates in landmark input
  landmarkInput.value = `${selectedCoords.lat.toFixed(6)}, ${selectedCoords.lng.toFixed(6)}`;
  mapPopup.style.display = "none";
});



</script>
</body>
</html>
